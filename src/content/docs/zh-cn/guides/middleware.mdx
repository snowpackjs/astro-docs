---
title: 中间件
description: 了解如何在Astro中使用中间件
i18nReady: true
---
import PackageManagerTabs from '~/components/tabs/PackageManagerTabs.astro';

**中间件**允许你拦截请求和响应，并在即将渲染页面或端点时动态注入行为。

这也允许你通过修改在所有 Astro 组件和 API 端点中可用的 locals 对象，设置和共享跨端点和页面的请求特定信息。

在 Astro 项目中 SSG 和 SSR 都可以使用中间件。

## 基本用法

1. 创建 `src/middleware.js|ts`（或者，你也可以创建 `src/middleware/index.js|ts`）

2. 在这个文件中，导出一个 [`onRequest()`](#onrequest) 函数。注意这不能是默认导出。

    ```js title="src/middleware.js"
    export function onRequest ({ locals, request }, next) {
        // 从请求拦截响应数据
        // 可选项，通过修改 `locals` 来转换响应
        locals.title = "New title";

        // 返回一个 Response 或者调用 `next()` 的结果
        return next();
    };
    ```

3. 在任何 `.astro` 文件中，使用 `Astro.locals` 访问响应数据。

```astro title="src/components/Component.astro"
---
const data = Astro.locals;
---
<h1>{data.title}</h1>
<p>这个 {data.property} 来自中间件。</p>
```

### 中间件类型

你可以导入然后使用实用函数 `defineMiddleware() `来使用类型保护：

```ts
// src/middleware.ts
import { defineMiddleware } from "astro/middleware";

// `context`和`next`自动类型定义
export const onRequest = defineMiddleware((context, next) => {

});
```
或者，如果你正在使用 JsDoc 来使用类型安全，你可以使用 `MiddlewareRequestHandler `：

```js
// src/middleware.js
/**
 * @type {import("astro").MiddlewareResponseHandler}
 */
// `context`和`next`自动类型定义
export const onRequest = (context, next) => {

};
```

To type the information inside `Astro.locals`, which gives you autocompletion inside `.astro` files and middleware code, declare a global namespace in the `env.d.ts` file:
要类型定义 `Astro.locals` 中的信息，这在 `.astro` 文件和中间件代码中为你提供自动完成，声明一个全局命名空间在env.d.ts文件中：

```ts title="src/env.d.ts"
/// <reference types="astro/client" />
declare namespace App {
    interface Locals {
        user: {
            name: string
        },
        welcomeTitle: () => string,
        orders: Map<string, object>
    }
}
```

然后，在中间件文件中，我们可以利用自动完成和类型安全。

你可以在 `Astro.locals` 中存储任何类型的数据：字符串，数字，甚至复杂的数据类型，如函数和映射。

```js title="src/middleware.js"
export function onRequest ({ locals, request }, next) {
    // 从请求拦截响应数据
    // 可选地，通过修改 `locals` 来转换响应
    locals.user.name = "John Wick";
    locals.welcomeTitle = () => {
        return "Welcome back " + locals.user.name;
    };

    // 返回一个Response或者调用 `next()` 的结果
    return next();
};
```

然后你可以在任何 `.astro` 文件中使用这个信息。

```astro title="src/pages/orders.astro"
---
const title = Astro.locals.welcomeTitle();
const orders = Array.from(Astro.locals.orders.entries());
---
<h1>{title}</h1>
<p>这个 {data.property} 来自中间件。</p>
<ul>
    {orders.map(order => {
        return <li>{/* do something with each order */}</li>;
    })}
</ul>
```

### 示例：删除敏感信息

下面的示例使用中间件将"私人信息"替换为"已删除"，以便你在页面上渲染修改后的HTML：

```js title="src/middleware.js"
export const onRequest = async (context, next) => {
    const response = await next();
    const html = await response.text();
    const redactedHtml = html.replaceAll("私人信息", "已删除");
    
    return new Response(redactedHtml, {
        status: 200,
        headers: response.headers
    });
};
```

### 中间件链式调用

可以使用 [`sequence()`](#sequence) 按指定顺序连接多个中间件：

```js title="src/middleware.js"
import { sequence } from "astro/middleware";

async function validation(_, next) {
    console.log("验证请求");
    const response = await next();
    console.log("验证响应");
    return response;
}

async function auth(_, next) {
    console.log("授权请求");
    const response = await next();
    console.log("授权响应");
    return response;
}

async function greeting(_, next) {
    console.log("问候请求");
    const response = await next();
    console.log("问候响应");
    return response;
}

export const onRequest = sequence(validation, auth, greeting);
```

控制台打印结果顺序如下：

```sh
验证请求
授权请求
问候请求
问候响应
授权响应
验证响应
```

## API 参考

### `onRequest()`

A required exported function from `src/middleware.js` that will be called before rendering every page or API route. It accepts two optional arguments: [context](#context) and [next()](#next). `onRequest()` must return a `Response`: either directly, or by calling `next()`.

### `context`

An object that includes information to be made available to other middleware, API routes and `.astro` routes during the rendering process.

This is an optional argument passed to `onRequest()` that may contain the [`locals`](#locals) object as well as any additional properties to be shared during rendering. For example, the `context` object may include cookies used in authentication.

This is the same [`context`](/en/reference/api-reference/#endpoint-context) object that is passed to API routes.

### `next()`

A function that intercepts (reads and modifies) the `Response` of a `Request` or calls the "next" middleware in the chain and returns a `Response`. For example, this function could modify the HTML body of a response.

This is an optional argument of `onRequest()`, and may provide the required `Response` returned by the middleware.

### `locals`
An object containing data from a `Response` that can be manipulated inside middleware. 

This `locals` object is forwarded across the request handling process and is available as a property to [`APIContext`](/en/reference/api-reference/#endpoint-context) and `AstroGlobal`. This allows data to be shared between middlewares, API routes, and `.astro` pages. This is useful for storing request-specific data, such as user data, across the rendering step.

`locals` is an object that lives and dies within a single Astro route; when your route page is rendered, `locals` won't exist anymore and a new one will be created. Information that needs to persist across multiple page requests must be stored elsewhere.

:::note
The value of `locals` cannot be overridden at run time. Doing so would risk wiping out all the information stored by the user.  In `dev` mode, Astro performs checks and will throw an error if `locals` are overridden.
:::

### `sequence()`

A function that accepts middleware functions as arguments, and will execute them in the order in which they are passed.


### `createContext`

A low-level API to create an [`APIContext`](/en/reference/api-reference/#endpoint-context), that can be used by the Astro middleware.

This function can be used by integrations/adapters to programmatically execute the Astro middleware.

### `trySerializeLocals`

A low-level API that takes in any value and tries to return a serialized version (a string) of it. If the value cannot be serialized, the function will throw a runtime error.
