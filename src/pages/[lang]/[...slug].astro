---
import languages from '../../i18n/languages';
import UIString from '../../components/UIString.astro';
import { Markdown } from 'astro/components';
import MainLayout from '../../layouts/MainLayout.astro';

export async function getStaticPaths() {
	const allPages = await Astro.glob('../**/*.md');
	const pagesByLang = allPages.reduce((pages, page) => {
		const lang = page.url.split('/')[1];
		if (!pages[lang]) pages[lang] = [];
		pages[lang].push(page);
		return pages;
	}, {} as { [lang: string]: typeof allPages });

	const paths = [];
	for (const page of pagesByLang.en) {
		const slug = page.url.slice(4)
		for (const lang of Object.keys(languages)) {
			if (lang === 'en') continue;
			const doesNotNeedFallback = pagesByLang[lang]?.some(p => p.url === `/${lang}/${slug}`);
			if (doesNotNeedFallback) continue;

			// TODO: This uses the undocumented Markdown loading API.
			// Replace once https://github.com/withastro/astro/pull/3056 is merged.
			// @ts-ignore
			const { frontmatter } = await page.default();
			paths.push({ params: { lang, slug }, props: { frontmatter } });
		}
	}
	return paths;
}

const { frontmatter } = Astro.props;
---

<MainLayout content={frontmatter}>
	<blockquote>
	  🌐 <UIString key="fallbackContent.notice" />
		<a href="https://github.com/withastro/docs/blob/main/src/i18n#readme"><UIString key="fallbackContent.linkText" /></a>
	</blockquote>
	<Markdown content={frontmatter.astro.source} />
</MainLayout>
