---
import { escapeHtml } from '../util';

const { lang, title, highlightedLines } = Astro.props;

const isTerminal = ['shellscript', 'shell', 'bash', 'sh', 'zsh'].includes(lang);

// Generate HTML code from the title (if any), improving the ability to wrap long file paths
// into multiple lines by inserting a line break opportunity after each slash
const titleHtml = title ? escapeHtml(title).replace(/([\\/])/g, '$1<wbr/>') : null;

// Render the default slot, which contains the syntax-highlighted code in HTML format
// as processed by Astro's Shiki integration
let codeSnippetHtml = await Astro.slots.render('default');

// If we were requested to highlight lines, do it now
if (highlightedLines.length > 0) {
	let lineNumber = 0;
	codeSnippetHtml = codeSnippetHtml.replace(/<span class="line">/g, () => {
		lineNumber++;
		const cssClasses = ['line'];
		if (highlightedLines.includes(lineNumber))
			cssClasses.push('highlighted');
		return `<span class="${cssClasses.join(' ')}">`;
	});
}
---
<style lang="scss" is:global>
	.code-snippet {
		--glow-border: 1px solid var(--theme-glow-highlight);
		filter: drop-shadow(0 0 0.3rem var(--theme-glow-diffuse));

		.header, pre {
			border: var(--glow-border);
			border-radius: 0.3rem;
			line-height: 1.65;
		}

		.header {
			display: none;
			border-bottom: none;
			padding: 0.25rem 1rem 0.25rem 1rem;
			line-height: 1.65;
			z-index: 1;
			position: relative;
			top: 1px;
			background-color: var(--theme-code-tabs);
			color: var(--theme-code-text);
			font-size: 0.9rem;
			font-weight: 500;
			letter-spacing: 0.025ch;
			border-bottom-left-radius: 0;
			border-bottom-right-radius: 0;
		}

		pre {
			margin: 0;
			padding: var(--padding-block) 0;
			background-color: var(--theme-code-bg) !important;

			&:focus-visible {
				outline: 3px solid var(--theme-accent);
				outline-offset: -3px;
			}

			& > code {
				all: unset;
				display: inline-block;
				min-width: 100%;
				--padding-inline: 1.25rem;

				& > .line {
					--accent-margin: 0rem;
					display: inline-block;
					min-width: calc(100% - var(--accent-margin));
					padding-inline-start: var(--padding-inline);
					padding-inline-end: calc(2 * var(--padding-inline));
				}

				& > .line.highlighted {
					--accent-margin: 0.25rem;
					--accent-width: 0.25rem;
					background: var(--theme-code-highlight-bg);
					margin-inline-start: var(--accent-margin);
					border-inline-start: var(--accent-width) solid var(--theme-code-highlight-border);
					padding-inline-start: calc(var(--padding-inline) - var(--accent-margin) - var(--accent-width)) !important;
				}
			}
		}

		&.has-title {
			& .header {
				display: inline-block;
			}

			& pre {
				border-top-left-radius: 0;
			}
		}

		&.is-terminal {
			--theme-glow-highlight: rgba(255, 255, 255, 0.2);
			--theme-glow-diffuse: rgba(0, 0, 0, 0.4);

			& .header {
				display: flex;
				align-items: center;
				justify-content: center;
				padding-bottom: 0.175rem;
				min-height: 1.75rem;
				position: relative;

				&::before {
					content: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 60 16' preserveAspectRatio='xMidYMid meet' fill='rgba(255, 255, 255, 0.15)'%3E%3Ccircle cx='8' cy='8' r='8'/%3E%3Ccircle cx='30' cy='8' r='8'/%3E%3Ccircle cx='52' cy='8' r='8'/%3E%3C/svg%3E");
					position: absolute;
					left: 1rem;
					width: 2.1rem;
					line-height: 0;
				}
			}

			& pre {
				border-top-left-radius: 0;
				border-top-right-radius: 0;
			}
		}
		
		::selection {
			color: white;
			background-color: var(--theme-code-selection-bg);
		}
	}
</style>
<figure class:list={[
	'code-snippet',
	isTerminal && 'is-terminal',
	titleHtml && 'has-title',
	`lang-${lang}`
]}>
	<figcaption class="header">{
		titleHtml && <span class="title" set:html={titleHtml} />
	}</figcaption>
	<Fragment set:html={codeSnippetHtml} />
</figure>
