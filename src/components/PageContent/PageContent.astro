---
import ArticleNavigationButton from './ArticleNavigationButton.astro';
import FallbackNotice from '../FallbackNotice.astro';
import TableOfContents from '../RightSidebar/TableOfContents';
import { getNav, useTranslations } from "../../i18n/util";
import { getLanguageFromURL } from '../../util';

const { content, currentPage, isFallback } = Astro.props;
const title = content.title;
const headers = content.astro?.headers;
const lang = getLanguageFromURL(Astro.canonicalURL.pathname);
const links = (await getNav(Astro)).filter((x) => !('header' in x) && x.slug) as { text: string; slug: string; }[];
const index = links.findIndex((x) => currentPage.includes(x.slug));
const makeLinkItem = ({ text, slug }) => ({ text, link: `/${lang}/${slug}/` });
let next, previous;
if (index > 0) previous = makeLinkItem(links[index - 1]);
if (index !== -1 && index < links.length - 1) next = makeLinkItem(links[index + 1]);
const t = useTranslations(Astro);
---

{
	// For best cross-browser support of `position: sticky`, sticky elements must not be nested
	// inside elements that hide any overflow axis. The article content hides `overflow-x`,
	// so we must place the sticky TOC here.
	headers && (
		<nav class="sticky-toc">
			<TableOfContents
				client:media="(max-width: 72em)"
				headers={headers}
				labels={{ onThisPage: t('rightSidebar.onThisPage'), overview: t('rightSidebar.overview') }}
				isMobile={true}
			/>
		</nav>
	)
}

<article id="article" class="content">
	<section class="main-section">
		<h1 class="content-title" id="overview" set:html={title} />
		{isFallback && <FallbackNotice />}
		<slot />
	</section>
	{(previous || next) && (
		<aside class="next-previous-nav">
			{previous && <ArticleNavigationButton rel="prev" item={previous} />}
			{next && <ArticleNavigationButton rel="next" item={next} />}
		</aside>
	)}
</article>

<style>
	.sticky-toc, .content {
		width: 100%;
		max-width: 80ch;
		margin-inline: auto;
	}

	.content {
		padding-block: var(--doc-padding-block);
		padding-inline: var(--min-spacing-inline);
		height: 100%;
		display: flex;
		flex-direction: column;
		overflow-x: hidden;
	}
	.content > section {
		margin-bottom: 4rem;
	}
	.next-previous-nav {
		display: flex;
		flex-wrap: wrap;
		width: auto;
		gap: 1rem;
		margin-bottom: 1.5rem;
	}

	.sticky-toc {
		display: block;
		position: sticky;
		z-index: 2;
		top: calc(var(--theme-navbar-height));
	}
	@media (min-width: 50em) {
		.sticky-toc {
			top: 0;
			margin-top: 0;
		}
	}
	@media (min-width: 72em) {
		.sticky-toc {
			display: none;
		}
	}
</style>
